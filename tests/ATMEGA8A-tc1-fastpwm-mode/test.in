#!/bin/sh
#
# NOTE: This script has been generated by mcusim-config. It is a good idea to
#       adjust it only if you know what you're doing.
#
# Copyright (c) 2017, 2018,
# Dmitry Salychev <darkness.bsd@gmail.com>,
# Alexander Salychev <ppsalex@rambler.ru> et al.
# All rights reserved.
#
# Redistribution and use in source and binary forms, with or without
# modification, are permitted provided that the following conditions are met:
#     * Redistributions of source code must retain the above copyright
#       notice, this list of conditions and the following disclaimer.
#     * Redistributions in binary form must reproduce the above copyright
#       notice, this list of conditions and the following disclaimer in the
#       documentation and/or other materials provided with the distribution.
#     * Neither the name of the <organization> nor the
#       names of its contributors may be used to endorse or promote products
#       derived from this software without specific prior written permission.
#
# THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS AS IS
# AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO,
# THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
# PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL <COPYRIGHT HOLDER> BE LIABLE FOR
# ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
# DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS
# OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
# HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT,
# STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN
# ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY
# OF SUCH DAMAGE.
#
# Site: www.mcusim.org
# Issue tracker: trac.mcusim.org
#

# Append models to the list in order to load them during simulation.
#MODELS="$MODELS ./dht11.lua"
#MODELS="$MODELS ./io.lua"
MODELS="$MODELS ./stop-test.lua"

# File to keep list of the models
MDL_LIST=$(mktemp /tmp/mcusim-modlist.XXXXXXX)
echo "# DO NOT MODIFY IT MANUALLY! FILE WILL BE REMOVED!" > $MDL_LIST
if [ ! -z "$MODELS" ]; then
        printf $MODELS >> $MDL_LIST
fi

if [ -z $1 ]; then
`which mcusim` -p m8a -r $MDL_LIST -f 16000000 --firmware-test -U flash:w:firmware.hex -U hfuse:w:0xC9:h -U lfuse:w:0xEF:h --dump-regs=TCNT1,OCR1A,OCR1B,TIFR4,TIFR3,TIFR2,PORTB,PORTB2,PORTB1; rc=$?
else
$1 -p m8a -r $MDL_LIST -f 16000000 --firmware-test -U flash:w:firmware.hex -U hfuse:w:0xC9:h -U lfuse:w:0xEF:h --dump-regs=TCNT1,OCR1A,OCR1B,TIFR4,TIFR3,TIFR2,PORTB,PORTB2,PORTB1; rc=$?
fi
rm "$MDL_LIST"
exit $rc
